<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduled Job Management Dashboard</title>
    <style>
        /* Base Styling & Typography */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --skip-color: #f97316;
            --skip-hover: #ea580c;
            --danger-color: #dc2626;
            --danger-hover: #b91c1c;
            --bg-light: #f7f9fb;
            --text-dark: #1f2937;
            --border-color: #e5e7eb;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Utility Classes */
        .flex-row-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .font-extrabold { font-weight: 800; }
        .text-gray-900 { color: var(--text-dark); }
        .mb-8 { margin-bottom: 2rem; }
        .mt-8 { margin-top: 2rem; }
        .pb-4 { padding-bottom: 1rem; }
        .border-b { border-bottom: 1px solid var(--border-color); }
        .p-4 { padding: 1rem; }
        .hidden { display: none !important; }
        .loading { opacity: 0.5; pointer-events: none; }

        /* Buttons and Form Styling */
        .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            border: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        /* Input and Textarea Styles */
        input[type="text"], input[type="password"], textarea, select, input[type="file"] {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            box-sizing: border-box;
            transition: border-color 0.15s;
        }

        /* --- Login Screen Styling --- */
        #login-view {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        .login-card {
            background-color: white;
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .login-card h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }
        .login-card p {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        .login-card label {
            text-align: left;
            margin-bottom: 0.5rem;
        }

        /* Dashboard Styles (rest of the original styles) */
        .btn-secondary {
            background-color: #f3f4f6;
            color: var(--text-dark);
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover {
            background-color: var(--danger-hover);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        .status-Active { background-color: #d1fae5; color: #065f46; }
        .status-Skipped { background-color: #fef3c7; color: #b45309; }

        .jobs-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 8px;
        }
        .job-card {
            background-color: white;
            padding: 1.25rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            transition: box-shadow 0.3s ease;
        }
        .script-preview {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            max-height: 100px;
            overflow-y: auto;
            color: #334155;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        
        @media (min-width: 640px) {
            .jobs-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .jobs-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="container">
        <!-- --- LOGIN VIEW --- -->
        <div id="login-view">
            <div class="login-card">
                <h2>Scheduler Dashboard Login</h2>
                <p>Use the default credentials to access the dashboard.</p>
                <p style="font-weight: 600; color: var(--danger-color); margin-bottom: 1rem;">
                    Default: admin / password
                </p>
                <form id="login-form">
                    <label for="username" style="display: block; text-align: left; font-weight: 600;">Username</label>
                    <input type="text" id="username" required placeholder="admin" value="admin">

                    <label for="password" style="display: block; text-align: left; font-weight: 600;">Password</label>
                    <input type="password" id="password" required placeholder="password" value="password">

                    <div id="login-status-message" class="p-4 hidden" style="border-radius: var(--radius-md); margin-bottom: 1.5rem; text-align: left;"></div>
                    
                    <button type="submit" id="login-button" class="btn btn-primary" style="width: 100%;">
                        Sign In
                    </button>
                </form>
            </div>
        </div>

        <!-- --- DASHBOARD VIEW (Initially Hidden) --- -->
        <div id="dashboard-view" class="hidden">
            <!-- Header -->
            <header class="mb-8">
                <div class="job-header flex-row-between border-b pb-4 mb-4">
                    <h1 class="text-3xl font-extrabold text-gray-900">Scheduled Job Dashboard</h1>
                    <button id="logout-button" class="btn btn-secondary btn-small" onclick="logout()">
                        Logout
                    </button>
                </div>
                <button id="add-job-button" class="btn btn-primary" onclick="openEditModal()">
                    + Add New Scheduled Job
                </button>
            </header>

            <!-- Status Message -->
            <div id="status-message" class="p-4 hidden" style="border-radius: var(--radius-md); margin-bottom: 1.5rem;"></div>

            <!-- Job List Container -->
            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-900" style="margin-bottom: 1rem;">Configured Scheduled Jobs</h2>
                <div id="jobs-list" class="jobs-grid">
                    <div class="empty-state" id="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 3rem 0; color: #6b7280;">
                         <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 3rem; height: 3rem; margin: 0 auto 0.5rem; color: #9ca3af;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 5h18a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <h3 style="font-size: 1rem; color: var(--text-dark); margin-top: 0.5rem;">No scheduled jobs configured</h3>
                        <p style="font-size: 0.875rem; margin-top: 0.25rem;">Use the button above to add a new cron-scheduled job.</p>
                    </div>
                </div>
            </div>
            
            <!-- Modals (Hidden by default) -->
             <div id="job-modal" class="modal hidden">...</div> <!-- Rest of modal content removed for brevity but exists in JS -->
             <div id="confirm-modal" class="modal hidden">...</div>
             <!-- The full modals are included in the original styles/logic and will be appended below -->
        </div>


        <!-- MODAL TEMPLATES (Keep them outside the main views for cleaner structure) -->
        <!-- Modal for Create/Update Job -->
        <div id="job-modal" class="modal">
            <div class="modal-content" id="modal-content">
                <h3 id="modal-title" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-dark);">Add New Job</h3>
                <form id="job-form">
                    <input type="hidden" id="job-id" value="">

                    <label for="title">Job Name</label>
                    <input type="text" id="title" required placeholder="e.g., Daily Database Cleanup">

                    <label for="description">Purpose/Description</label>
                    <textarea id="description" rows="2" required placeholder="What does this scheduled job do?"></textarea>
                    
                    <label for="cron-expression">Cron Expression</label>
                    <input type="text" id="cron-expression" required placeholder="e.g., 0 2 * * * (runs at 2:00 AM daily)">

                    <!-- Script Input/Upload Toggle -->
                    <div style="margin-bottom: 0.5rem;">
                        <label>Script Source</label>
                        <div class="script-input-toggle" style="display:flex; gap: 1rem; margin-bottom: 1rem;">
                            <label><input type="radio" name="script-source" value="write" checked> Write Script Directly</label>
                            <label><input type="radio" name="script-source" value="upload"> Upload Script File</label>
                        </div>
                    </div>
                    
                    <!-- Textarea for Direct Input -->
                    <div id="script-writer-container">
                        <label for="script-content-input">Shell Script Content</label>
                        <textarea id="script-content-input" rows="6" required placeholder="#!/bin/bash&#10;echo 'Running job...'"></textarea>
                    </div>

                    <!-- File Input for Upload -->
                    <div id="script-upload-container" class="hidden">
                        <label for="script-file-input">Upload Shell Script File (.sh, .py, etc.)</label>
                        <input type="file" id="script-file-input" accept=".sh,.py,.txt">
                        <p id="file-status" style="font-size: 0.75rem; color: #4f46e5; margin-top: -0.75rem; margin-bottom: 1rem;">
                            (File content will be read and saved with the job)
                        </p>
                    </div>

                    <!-- Hidden field to always store the final script content -->
                    <input type="hidden" id="script-content-final" required>
                    

                    <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary btn-small" onclick="closeEditModal()">
                            Cancel
                        </button>
                        <button type="submit" id="modal-submit-button" class="btn btn-primary btn-small">
                            Save Job
                        </button>
                    </div>
                </form>
            </div>
        </div>

         <!-- Confirmation Modal (Hidden) -->
        <div id="confirm-modal" class="modal">
            <div class="modal-content" id="confirm-modal-content" style="max-width: 400px;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-dark);">Confirm Deletion</h3>
                <p style="color: #4b5563; margin-bottom: 1.5rem;">Are you sure you want to delete this job? This action cannot be undone.</p>
                <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                    <button type="button" class="btn btn-secondary btn-small" onclick="closeConfirmModal()">
                        Cancel
                    </button>
                    <button type="button" id="confirm-delete-button" class="btn btn-danger btn-small">
                        Delete
                    </button>
                </div>
            </div>
        </div>


    </div>

    <!-- Main JavaScript Logic - NOW INTEGRATED WITH GO BACKEND API -->
    <script>
        // Base API URL - Change this if your Go server runs on a different address/port
        const API_BASE_URL = window.location.origin === 'null' ? 'http://localhost:8080' : '';
        const API_JOBS_URL = `${API_BASE_URL}/api/jobs`;
        const API_LOGIN_URL = `${API_BASE_URL}/login`;
        const AUTH_TOKEN_KEY = 'authToken';

        // --- DOM Elements & Global State ---

        const appEl = document.getElementById('app');
        const jobsListEl = document.getElementById('jobs-list');
        const jobFormEl = document.getElementById('job-form');
        const editModalEl = document.getElementById('job-modal');
        const confirmModalEl = document.getElementById('confirm-modal');
        const statusMessageEl = document.getElementById('status-message');
        const loginStatusMessageEl = document.getElementById('login-status-message');
        const emptyStateEl = document.getElementById('empty-state');
        const loginViewEl = document.getElementById('login-view');
        const dashboardViewEl = document.getElementById('dashboard-view');
        const loginFormEl = document.getElementById('login-form');

        // Elements for job form logic (re-used from previous version)
        const scriptContentInputEl = document.getElementById('script-content-input');
        const scriptFileInputEl = document.getElementById('script-file-input');
        const scriptContentFinalEl = document.getElementById('script-content-final');
        const scriptWriterContainerEl = document.getElementById('script-writer-container');
        const scriptUploadContainerEl = document.getElementById('script-upload-container');


        // --- Utility Functions ---

        /** Retrieves the stored authentication token. */
        function getAuthToken() {
            return localStorage.getItem(AUTH_TOKEN_KEY);
        }

        /** Creates the standard request headers, including Authorization. */
        function getAuthHeaders() {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            return headers;
        }

        /** Displays a temporary status message to the user. */
        function showStatus(message, isError = false, target = statusMessageEl) {
            target.textContent = message;
            target.classList.remove('hidden');

            if (isError) {
                target.style.backgroundColor = '#fee2e2';
                target.style.color = '#991b1b';
            } else {
                target.style.backgroundColor = '#d1fae5';
                target.style.color = '#065f46';
            }

            // Hide after 5 seconds, but clear any pending timeout first
            clearTimeout(target.timeoutId);
            target.timeoutId = setTimeout(() => {
                target.classList.add('hidden');
            }, 5000);
        }

        /** Sets or removes a loading state on the main app content. */
        function setLoading(isLoading) {
            if (isLoading) {
                appEl.classList.add('loading');
            } else {
                appEl.classList.remove('loading');
            }
        }

        /** Utility function to handle API responses and unauthorized errors. */
        async function handleResponse(response) {
            if (response.status === 401) {
                // If unauthorized, force logout and redirect to login
                logout(true, "Session expired or unauthorized. Please log in again.");
                throw new Error("Unauthorized access. Redirecting to login.");
            }

            if (!response.ok) {
                let errorMessage = `HTTP error! status: ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorMessage = errorBody.error || errorMessage;
                } catch {
                    // Ignore if response is not JSON
                }
                throw new Error(errorMessage);
            }
            if (response.status === 204) return {}; // No Content
            return response.json();
        }
        
        // --- Authentication Logic ---

        window.logout = (silent = false, message = "Logged out successfully.") => {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            dashboardViewEl.classList.add('hidden');
            loginViewEl.classList.remove('hidden');
            loginFormEl.reset();
            
            if (!silent) {
                 showStatus(message, false, loginStatusMessageEl);
            }
        };

        loginFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(API_LOGIN_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await handleResponse(response);
                
                if (result.token) {
                    localStorage.setItem(AUTH_TOKEN_KEY, result.token);
                    showStatus("Login successful! Loading dashboard...", false, loginStatusMessageEl);
                    checkAuthAndRender();
                } else {
                    showStatus("Login failed. Check username and password.", true, loginStatusMessageEl);
                }
            } catch (error) {
                console.error("Login Error:", error);
                const msg = error.message.includes("401") ? "Invalid username or password." : `Connection error: ${error.message}`;
                showStatus(msg, true, loginStatusMessageEl);
            } finally {
                setLoading(false);
            }
        });

        async function checkAuthAndRender() {
            const token = getAuthToken();
            if (!token) {
                // No token found, show login
                dashboardViewEl.classList.add('hidden');
                loginViewEl.classList.remove('hidden');
                return;
            }

            // Token exists, attempt to fetch jobs to validate it
            try {
                await fetchJobs();
                loginViewEl.classList.add('hidden');
                dashboardViewEl.classList.remove('hidden');
            } catch (error) {
                // If fetchJobs fails (likely 401), handleResponse calls logout
                console.error("Auth check failed:", error);
                if (!error.message.includes("Unauthorized")) {
                    logout(false, "Failed to connect to API or internal error. Please log in.");
                }
            }
        }

        // --- API Integration Functions (Modified to include Auth Headers) ---

        async function fetchJobs() {
            const response = await fetch(API_JOBS_URL, { headers: getAuthHeaders() });
            return await handleResponse(response);
        }

        async function createOrUpdateJob(jobData) {
            const response = await fetch(API_JOBS_URL, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(jobData)
            });
            return await handleResponse(response);
        }

        async function deleteJob(jobId) {
            const response = await fetch(`${API_JOBS_URL}/${jobId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            return await handleResponse(response);
        }
        
        async function skipJob(jobId) {
            const response = await fetch(`${API_JOBS_URL}/${jobId}/skip`, {
                method: 'POST',
                headers: getAuthHeaders()
            });
            return await handleResponse(response);
        }


        // --- Job Management Logic (Unchanged besides API calls) ---

        function getNextRunTime(cron, skipCount = 0) {
            const dateOptions = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            let now = new Date();
            let nextRun = new Date(now.getTime() + (skipCount + 1) * 86400000); 
            let timeString = nextRun.toLocaleString(undefined, dateOptions);

            if (skipCount > 0) {
                return `SKIPPED (${skipCount} times) - ${timeString}`;
            }
            return timeString;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleDateString(undefined, {
                year: 'numeric', month: 'short', day: 'numeric'
            });
        }
        
        function renderJobs(jobArray) {
            jobsListEl.innerHTML = '';
            
            if (jobArray.length === 0) {
                emptyStateEl.style.display = 'block';
                return;
            }
            emptyStateEl.style.display = 'none';

            jobArray.forEach(job => {
                const jobCard = document.createElement('div');
                jobCard.className = 'job-card';

                const status = job.skipCount > 0 ? 'Skipped' : 'Active';
                const statusBadge = `<span class="status-badge status-${status}">${status.toUpperCase()} (${job.skipCount})</span>`;
                
                const nextRunTime = getNextRunTime(job.cronExpression, job.skipCount);
                const scriptSummary = job.scriptContent.substring(0, 50) + (job.scriptContent.length > 50 ? '...' : '');

                jobCard.innerHTML = `
                    <div style="display: flex; flex-direction: column; height: 100%;">
                        <div class="flex-row-between" style="margin-bottom: 0.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--text-dark);">${job.title}</h3>
                            ${statusBadge}
                        </div>
                        <p style="font-size: 0.875rem; color: #4b5563; margin-bottom: 1rem; flex-grow: 1;">${job.description}</p>
                        
                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem; color: #374151;">
                            <strong>Cron:</strong> <span style="font-family: monospace; background-color: #f1f1f1; padding: 2px 6px; border-radius: 4px;">${job.cronExpression}</span>
                        </div>
                         <div style="font-size: 0.875rem; margin-bottom: 0.5rem; color: #374151;">
                            <strong>Next Run:</strong> <span id="next-run-${job.id}" style="font-weight: 600; color: ${job.skipCount > 0 ? '#b45309' : '#065f46'};">${nextRunTime}</span>
                        </div>
                        <div style="font-size: 0.875rem; color: #4b5563;">
                            <strong>Script Snippet:</strong>
                            <div class="script-preview">${scriptSummary}</div>
                        </div>

                        <div style="margin-top: 1rem;">
                           <button class="btn btn-skip btn-small" onclick="handleSkipJob('${job.id}')">
                               Skip Next Run 
                           </button>
                        </div>
                        
                        <div class="card-footer flex-row-between" style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6; font-size: 0.75rem; color: #6b7280;">
                            <p>ID: ${job.ID}</p>
                            <div class="card-actions">
                                <button class="edit" onclick='openEditModal(${JSON.stringify(job)})' style="background: none; border: none; cursor: pointer; font-weight: 600; padding: 0 0.5rem; color: var(--primary-color);">
                                    Edit
                                </button>
                                |
                                <button class="delete" onclick="openConfirmModal('${job.id}')" style="background: none; border: none; cursor: pointer; font-weight: 600; padding: 0 0.5rem; color: var(--danger-color);">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                jobsListEl.appendChild(jobCard);
            });
        }


        window.openEditModal = (job = null) => {
             // ... [Modal control logic remains the same] ...
            const isEditing = job !== null;
            document.getElementById('job-id').value = isEditing ? job.id : '';
            document.getElementById('title').value = isEditing ? job.title : '';
            document.getElementById('description').value = isEditing ? job.description : '';
            document.getElementById('cron-expression').value = isEditing ? job.cronExpression : '';
            
            const scriptContent = isEditing ? job.scriptContent : '';
            document.getElementById('script-content-input').value = scriptContent;
            document.getElementById('script-content-final').value = scriptContent;

            document.querySelector('input[name="script-source"][value="write"]').checked = true;
            document.querySelector('input[name="script-source"]').dispatchEvent(new Event('change'));
            
            scriptFileInputEl.value = '';
            document.getElementById('file-status').textContent = '(File content will be read and saved with the job)';

            document.getElementById('modal-title').textContent = isEditing ? 'Edit Scheduled Job' : 'Add New Scheduled Job';
            document.getElementById('modal-submit-button').textContent = isEditing ? 'Update Job' : 'Save Job';

            editModalEl.classList.add('is-visible');
        };

        window.closeEditModal = () => {
            editModalEl.classList.remove('is-visible');
            jobFormEl.reset();
            document.getElementById('job-id').value = '';
        };

        let jobIdToDelete = null;

        window.openConfirmModal = (jobId) => {
            jobIdToDelete = jobId;
            document.getElementById('confirm-delete-button').onclick = () => handleJobDelete(jobIdToDelete);
            confirmModalEl.classList.add('is-visible');
        };

        window.closeConfirmModal = () => {
            confirmModalEl.classList.remove('is-visible');
            jobIdToDelete = null;
        };


        async function handleSkipJob(jobId) {
            setLoading(true);
            try {
                const result = await skipJob(jobId);
                showStatus(`Job ID ${jobId} successfully skipped! New skip count: ${result.skipCount}`, false);
                loadJobs();
            } catch (error) {
                console.error("Error skipping job:", error);
                showStatus(`Failed to skip job. Error: ${error.message || 'Unknown error'}`, true);
            } finally {
                setLoading(false);
            }
        }

        async function loadJobs() {
            setLoading(true);
            try {
                const jobArray = await fetchJobs();
                renderJobs(jobArray);
            } catch (error) {
                // handleResponse already takes care of 401/logout here
                console.error("Error loading jobs:", error);
                if (!error.message.includes("Unauthorized")) {
                    showStatus('Failed to load jobs from API. Ensure Go server is running.', true);
                }
                renderJobs([]); 
            } finally {
                setLoading(false);
            }
        }

        jobFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);

            const jobId = document.getElementById('job-id').value;
            
            let finalScriptContent = '';
            const scriptSource = document.querySelector('input[name="script-source"]:checked').value;
            
            if (scriptSource === 'write') {
                finalScriptContent = scriptContentInputEl.value;
            } else {
                finalScriptContent = scriptContentFinalEl.value;
            }

            const jobData = {
                id: jobId,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                cronExpression: document.getElementById('cron-expression').value,
                scriptContent: finalScriptContent,
            };

            if (!jobData.title || !jobData.cronExpression || !jobData.scriptContent) {
                showStatus('Please fill out all required fields and ensure a script is provided.', true);
                setLoading(false);
                return;
            }

            closeEditModal();

            try {
                await createOrUpdateJob(jobData);
                
                if (jobId) {
                    showStatus('Scheduled job successfully updated!', false);
                } else {
                    showStatus('New scheduled job successfully added!', false);
                }
                loadJobs();
            } catch (error) {
                console.error("Error saving job:", error);
                showStatus(`Failed to save job. Error: ${error.message || 'Unknown error'}`, true);
            } finally {
                setLoading(false);
            }
        });

        async function handleJobDelete(jobId) {
            closeConfirmModal();
            setLoading(true);
            try {
                await deleteJob(jobId);
                showStatus('Scheduled job successfully deleted!', false);
                loadJobs();
            } catch (error) {
                console.error("Error deleting job:", error);
                showStatus(`Failed to delete job. Error: ${error.message || 'Unknown error'}`, true);
            } finally {
                setLoading(false);
            }
        }

        // --- Script Input/Upload Logic (Re-used) ---

        document.querySelectorAll('input[name="script-source"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'write') {
                    scriptWriterContainerEl.classList.remove('hidden');
                    scriptUploadContainerEl.classList.add('hidden');
                    scriptFileInputEl.required = false;
                    scriptContentInputEl.required = true;
                    scriptContentFinalEl.value = scriptContentInputEl.value;
                } else {
                    scriptWriterContainerEl.classList.add('hidden');
                    scriptUploadContainerEl.classList.remove('hidden');
                    scriptFileInputEl.required = true;
                    scriptContentInputEl.required = false;
                    scriptContentInputEl.value = ''; 
                }
                scriptFileInputEl.value = '';
                document.getElementById('file-status').textContent = '(File content will be read and saved with the job)';
            });
        });

        scriptFileInputEl.addEventListener('change', (e) => {
            const file = e.target.files[0];
            const fileStatusEl = document.getElementById('file-status');
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    scriptContentFinalEl.value = event.target.result;
                    fileStatusEl.textContent = `Script file loaded: ${file.name}. Ready to save.`;
                };
                reader.onerror = function() {
                    fileStatusEl.textContent = 'Error reading file.';
                    scriptContentFinalEl.value = '';
                };
                reader.readAsText(file);
            } else {
                scriptContentFinalEl.value = '';
                fileStatusEl.textContent = '(File content will be read and saved with the job)';
            }
        });

        scriptContentInputEl.addEventListener('input', () => {
            if (document.querySelector('input[name="script-source"]:checked').value === 'write') {
                 scriptContentFinalEl.value = scriptContentInputEl.value;
            }
        });

        // --- Initialization ---

        window.addEventListener('load', checkAuthAndRender); // Check auth on load

        editModalEl.addEventListener('click', (e) => { if (e.target === editModalEl) closeEditModal(); });
        confirmModalEl.addEventListener('click', (e) => { if (e.target === confirmModalEl) closeConfirmModal(); });

    </script>
</body>
</html>
