<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduled Job Management Dashboard</title>
    <style>
        /* Base Styling & Typography */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --skip-color: #f97316; /* Orange for skip */
            --skip-hover: #ea580c;
            --danger-color: #dc2626;
            --danger-hover: #b91c1c;
            --bg-light: #f7f9fb;
            --text-dark: #1f2937;
            --border-color: #e5e7eb;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Utility Classes */
        .flex-row-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .font-extrabold { font-weight: 800; }
        .text-gray-900 { color: var(--text-dark); }
        .mb-8 { margin-bottom: 2rem; }
        .mt-8 { margin-top: 2rem; }
        .pb-4 { padding-bottom: 1rem; }
        .border-b { border-bottom: 1px solid var(--border-color); }
        .p-4 { padding: 1rem; }
        .hidden { display: none !important; }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            border: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-skip {
            background-color: var(--skip-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.3);
        }
        .btn-skip:hover {
            background-color: var(--skip-hover);
        }

        .btn-secondary {
            background-color: #f3f4f6;
            color: var(--text-dark);
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover {
            background-color: var(--danger-hover);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        /* Active (Green) */
        .status-Active { background-color: #d1fae5; color: #065f46; }
        /* Skipped (Orange) - only used temporarily for feedback */
        .status-Skipped { background-color: #fef3c7; color: #b45309; }

        /* Card Layout and Responsiveness */
        .jobs-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr; /* Mobile default */
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 8px; /* For scrollbar space */
        }
        .job-card {
            background-color: white;
            padding: 1.25rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            transition: box-shadow 0.3s ease;
        }
        .job-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .card-footer {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f3f4f6;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .card-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            padding: 0 0.5rem;
            transition: color 0.15s;
        }
        .card-actions .edit { color: var(--primary-color); }
        .card-actions .delete { color: var(--danger-color); }
        .card-actions .edit:hover { color: var(--primary-hover); }
        .card-actions .delete:hover { color: var(--danger-hover); }
        
        /* Script Content Preview */
        .script-preview {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            max-height: 100px;
            overflow-y: auto;
            color: #334155;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Desktop and Tablet Layout */
        @media (min-width: 640px) {
            .jobs-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .jobs-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.is-visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            width: 90%;
            max-width: 600px; /* Wider for better form layout */
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal.is-visible .modal-content {
            transform: translateY(0);
        }

        /* Form Controls */
        label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }
        input[type="text"], textarea, select, input[type="file"] {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            box-sizing: border-box;
            transition: border-color 0.15s;
        }
        textarea {
            font-family: monospace;
            min-height: 150px;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        /* Script Input Toggle Group */
        .script-input-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .script-input-toggle label {
            display: flex;
            align-items: center;
            font-weight: 400;
            margin-right: 1rem;
            cursor: pointer;
        }
        .script-input-toggle input[type="radio"] {
            margin-right: 0.5rem;
            width: auto;
            margin-bottom: 0;
        }

        /* Empty State */
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem 0;
            color: #6b7280;
        }
        .empty-state svg {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 0.5rem;
            color: #9ca3af;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="container">
        <!-- Header -->
        <header class="mb-8">
            <div class="job-header flex-row-between border-b pb-4 mb-4">
                <h1 class="text-3xl font-extrabold text-gray-900">Scheduled Job Dashboard</h1>
            </div>
            <button id="add-job-button" class="btn btn-primary" onclick="openEditModal()">
                + Add New Scheduled Job
            </button>
        </header>

        <!-- Status Message -->
        <div id="status-message" class="p-4 hidden" style="border-radius: var(--radius-md); margin-bottom: 1.5rem;"></div>

        <!-- Job List Container -->
        <div class="mt-8">
            <h2 class="text-2xl font-semibold text-gray-900" style="margin-bottom: 1rem;">Configured Scheduled Jobs</h2>
            <div id="jobs-list" class="jobs-grid">
                <!-- Job cards will be inserted here by JavaScript -->
                <div class="empty-state" id="empty-state">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 5h18a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <h3 style="font-size: 1rem; color: var(--text-dark); margin-top: 0.5rem;">No scheduled jobs configured</h3>
                    <p style="font-size: 0.875rem; margin-top: 0.25rem;">Use the button above to add a new cron-scheduled job.</p>
                </div>
            </div>
        </div>

        <!-- Modal for Create/Update Job -->
        <div id="job-modal" class="modal">
            <div class="modal-content" id="modal-content">
                <h3 id="modal-title" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-dark);">Add New Job</h3>
                <form id="job-form">
                    <input type="hidden" id="job-id" value="">

                    <label for="title">Job Name</label>
                    <input type="text" id="title" required placeholder="e.g., Daily Database Cleanup">

                    <label for="description">Purpose/Description</label>
                    <textarea id="description" rows="2" required placeholder="What does this scheduled job do?"></textarea>
                    
                    <label for="cron-expression">Cron Expression</label>
                    <input type="text" id="cron-expression" required placeholder="e.g., 0 2 * * * (runs at 2:00 AM daily)">

                    <!-- Script Input/Upload Toggle -->
                    <div style="margin-bottom: 0.5rem;">
                        <label>Script Source</label>
                        <div class="script-input-toggle">
                            <label><input type="radio" name="script-source" value="write" checked> Write Script Directly</label>
                            <label><input type="radio" name="script-source" value="upload"> Upload Script File</label>
                        </div>
                    </div>
                    
                    <!-- Textarea for Direct Input -->
                    <div id="script-writer-container">
                        <label for="script-content-input">Shell Script Content</label>
                        <textarea id="script-content-input" rows="6" required placeholder="#!/bin/bash&#10;echo 'Running job...'"></textarea>
                    </div>

                    <!-- File Input for Upload -->
                    <div id="script-upload-container" class="hidden">
                        <label for="script-file-input">Upload Shell Script File (.sh, .py, etc.)</label>
                        <input type="file" id="script-file-input" accept=".sh,.py,.txt">
                        <p id="file-status" style="font-size: 0.75rem; color: #4f46e5; margin-top: -0.75rem; margin-bottom: 1rem;">
                            (File content will be read and saved with the job)
                        </p>
                    </div>

                    <!-- Hidden field to always store the final script content -->
                    <input type="hidden" id="script-content-final" required>
                    

                    <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary btn-small" onclick="closeEditModal()">
                            Cancel
                        </button>
                        <button type="submit" id="modal-submit-button" class="btn btn-primary btn-small">
                            Save Job
                        </button>
                    </div>
                </form>
            </div>
        </div>

         <!-- Confirmation Modal (Hidden) -->
        <div id="confirm-modal" class="modal">
            <div class="modal-content" id="confirm-modal-content" style="max-width: 400px;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-dark);">Confirm Deletion</h3>
                <p style="color: #4b5563; margin-bottom: 1.5rem;">Are you sure you want to delete this job? This action cannot be undone.</p>
                <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                    <button type="button" class="btn btn-secondary btn-small" onclick="closeConfirmModal()">
                        Cancel
                    </button>
                    <button type="button" id="confirm-delete-button" class="btn btn-danger btn-small">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main JavaScript Logic - NOTE: The fetch functions below need to be updated to point to the Go API -->
    <script>
        // --- API Integration Setup ---

        // In a real environment, you would replace these mock functions 
        // with actual `fetch` calls to the Go backend on http://localhost:8080.
        // For this self-contained demo, we keep the mock functions for rendering.

        // --- Mock Data Store and API Simulation ---

        // In-memory array to store job objects. Note the new 'skipCount' field.
        let jobs = [
            { id: 'job-1', title: 'Database Backup', description: 'Run daily incremental backup of production database.', scriptContent: '#!/bin/bash\\necho "Starting daily database backup..."\\n/usr/bin/pg_dumpall | gzip > /tmp/backup.sql.gz', cronExpression: '0 2 * * *', skipCount: 0, createdAt: Date.now() - 86400000 },
            { id: 'job-2', title: 'Cache Purge', description: 'Clear old cache entries from CDN and local storage.', scriptContent: '#!/bin/bash\\n/usr/bin/curl -X POST https://cdn/purge', cronExpression: '*/30 * * * *', skipCount: 0, createdAt: Date.now() - 172800000 },
            { id: 'job-3', title: 'Monthly Report Generation', description: 'Generate and email monthly performance metrics report.', scriptContent: '/usr/bin/python3 /home/user/reports/monthly.py', cronExpression: '0 9 1 * *', skipCount: 0, createdAt: Date.now() - 345600000 }
        ];
        let nextJobId = 4; // Simple counter for new IDs

        // Simulate API latency
        const MOCK_LATENCY = 500;

        // Mock cron parser (using a simple utility for this demo)
        const CRON_PARTS = [
            { id: '*/30 * * * *', intervalMs: 30 * 60 * 1000 }, // Every 30 minutes
            { id: '0 2 * * *', intervalMs: 24 * 60 * 60 * 1000 }, // Daily
            { id: '0 9 1 * *', intervalMs: 30 * 24 * 60 * 60 * 1000 } // Monthly (approx)
        ];

        /** Generates a unique ID (simple UUID approximation for mock). */
        function generateId() {
            return 'job-' + nextJobId++;
        }

        /** (MOCK API) Fetches all jobs. */
        function fetchJobs() {
            return new Promise(resolve => {
                setTimeout(() => {
                    // Sort jobs by creation date (newest first)
                    const sortedJobs = [...jobs].sort((a, b) => b.createdAt - a.createdAt);
                    // If connecting to Go, this would be: 
                    // const response = await fetch('/api/jobs'); 
                    resolve({ success: true, data: sortedJobs });
                }, MOCK_LATENCY);
            });
        }

        /** (MOCK API) Creates a new job. */
        function createJob(jobData) {
            return new Promise(resolve => {
                setTimeout(() => {
                    const newJob = {
                        ...jobData,
                        id: generateId(),
                        skipCount: 0, // Initialize skip count
                        createdAt: Date.now()
                    };
                    jobs.push(newJob);
                    // If connecting to Go, this would be: 
                    // const response = await fetch('/api/jobs', { method: 'POST', body: JSON.stringify(jobData) });
                    resolve({ success: true, job: newJob });
                }, MOCK_LATENCY);
            });
        }

        /** (MOCK API) Updates an existing job. */
        function updateJob(jobId, jobData) {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const index = jobs.findIndex(j => j.id === jobId);
                    if (index > -1) {
                        // Preserve the original createdAt/id/skipCount if not provided in jobData
                        jobs[index] = { ...jobs[index], ...jobData }; 
                        resolve({ success: true, job: jobs[index] });
                    } else {
                        reject({ success: false, message: 'Job not found' });
                    }
                }, MOCK_LATENCY);
            });
        }

        /** (MOCK API) Deletes a job. */
        function deleteJob(jobId) {
            return new Promise(resolve => {
                setTimeout(() => {
                    jobs = jobs.filter(j => j.id !== jobId);
                    // If connecting to Go, this would be: 
                    // await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
                    resolve({ success: true });
                }, MOCK_LATENCY);
            });
        }
        
        /**
         * Mocks the calculation of the next run time from a cron expression,
         * taking into account the skipCount.
         */
        function getNextRunTime(cron, skipCount = 0) {
            const now = new Date();
            const dateOptions = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            const cronInfo = CRON_PARTS.find(c => c.id === cron);
            
            if (cronInfo) {
                const interval = cronInfo.intervalMs;
                
                // Base time calculation (Mocking the next immediate run)
                let nextRun = new Date(now.getTime() + 1000); // Start just after now

                // Complex logic needed here in real life. For the mock, we simulate 
                // advancing time by (skipCount + 1) intervals, or just 1 interval if skipCount is 0.
                
                // Mock: Simple advancement based on a predefined interval
                let targetRun = new Date(now.getTime() + (skipCount + 1) * interval);
                
                // If it's the daily job, we ensure the time component is correct.
                if (cron === '0 2 * * *') {
                    // Ensure the time is exactly 2:00 AM on the day determined by the interval logic
                    let tempDate = new Date(targetRun);
                    tempDate.setHours(2, 0, 0, 0);
                    
                    // If the current time is after 2:00 AM, the first run is tomorrow at 2:00 AM.
                    // If skipping, it advances from that first run time.
                    if (skipCount === 0) {
                        if (now.getHours() >= 2) tempDate.setDate(tempDate.getDate() + 1);
                    } else {
                        // For every skip, advance exactly one day from the mock's first run time
                        tempDate.setDate(tempDate.getDate() + skipCount);
                    }
                    nextRun = tempDate;
                } else {
                    nextRun = targetRun;
                }

                return nextRun.toLocaleString(undefined, dateOptions);
            }
            
            // Fallback for unknown crons (advances by skipCount intervals + 4 hours)
            let fallbackRun = new Date(now.getTime());
            fallbackRun.setHours(fallbackRun.getHours() + 4 + skipCount * 4);
            return fallbackRun.toLocaleString(undefined, dateOptions);
        }

        // --- DOM Elements & Global State ---

        const jobsListEl = document.getElementById('jobs-list');
        const jobFormEl = document.getElementById('job-form');
        const editModalEl = document.getElementById('job-modal');
        const confirmModalEl = document.getElementById('confirm-modal');
        const statusMessageEl = document.getElementById('status-message');
        const emptyStateEl = document.getElementById('empty-state');

        const scriptContentInputEl = document.getElementById('script-content-input');
        const scriptFileInputEl = document.getElementById('script-file-input');
        const scriptContentFinalEl = document.getElementById('script-content-final');
        const scriptWriterContainerEl = document.getElementById('script-writer-container');
        const scriptUploadContainerEl = document.getElementById('script-upload-container');

        // --- Utility Functions ---

        /** Displays a temporary status message to the user. */
        function showStatus(message, isError = false) {
            statusMessageEl.textContent = message;
            statusMessageEl.classList.remove('hidden');

            if (isError) {
                statusMessageEl.style.backgroundColor = '#fee2e2';
                statusMessageEl.style.color = '#991b1b';
            } else {
                statusMessageEl.style.backgroundColor = '#d1fae5';
                statusMessageEl.style.color = '#065f46';
            }

            setTimeout(() => {
                statusMessageEl.classList.add('hidden');
            }, 5000);
        }

        /** Converts timestamp to a readable date string. */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleDateString(undefined, {
                year: 'numeric', month: 'short', day: 'numeric'
            });
        }
        
        // --- Script Input/Upload Logic ---

        document.querySelectorAll('input[name="script-source"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'write') {
                    scriptWriterContainerEl.classList.remove('hidden');
                    scriptUploadContainerEl.classList.add('hidden');
                    scriptFileInputEl.required = false;
                    scriptContentInputEl.required = true;
                } else {
                    scriptWriterContainerEl.classList.add('hidden');
                    scriptUploadContainerEl.classList.remove('hidden');
                    scriptFileInputEl.required = true;
                    scriptContentInputEl.required = false;
                    // Clear text area to force file upload if selected
                    scriptContentInputEl.value = ''; 
                }
                // Clear file input on mode switch to prevent stale data
                scriptFileInputEl.value = '';
                document.getElementById('file-status').textContent = '(File content will be read and saved with the job)';
            });
        });

        scriptFileInputEl.addEventListener('change', (e) => {
            const file = e.target.files[0];
            const fileStatusEl = document.getElementById('file-status');
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Store the content in the hidden input for form submission
                    scriptContentFinalEl.value = event.target.result;
                    fileStatusEl.textContent = `Script file loaded: ${file.name}. Ready to save.`;
                };
                reader.onerror = function() {
                    fileStatusEl.textContent = 'Error reading file.';
                    scriptContentFinalEl.value = '';
                };
                reader.readAsText(file);
            } else {
                scriptContentFinalEl.value = '';
                fileStatusEl.textContent = '(File content will be read and saved with the job)';
            }
        });

        /** Handles rendering the jobs from the data array. */
        function renderJobs(jobArray) {
            jobsListEl.innerHTML = '';
            
            if (!emptyStateEl) return;

            if (jobArray.length === 0) {
                emptyStateEl.style.display = 'block';
                return;
            }
            emptyStateEl.style.display = 'none';

            jobArray.forEach(job => {
                const jobCard = document.createElement('div');
                jobCard.className = 'job-card';

                const status = job.skipCount > 0 ? 'Skipped' : 'Active';
                const statusBadge = `<span class="status-badge status-${status}">${status.toUpperCase()}</span>`;
                
                // Calculate next run time based on current skip count
                const nextRunTime = getNextRunTime(job.cronExpression, job.skipCount);
                const scriptSummary = job.scriptContent.substring(0, 50) + (job.scriptContent.length > 50 ? '...' : '');

                jobCard.innerHTML = `
                    <div style="display: flex; flex-direction: column; height: 100%;">
                        <div class="flex-row-between" style="margin-bottom: 0.5rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--text-dark);">${job.title}</h3>
                            ${statusBadge}
                        </div>
                        <p style="font-size: 0.875rem; color: #4b5563; margin-bottom: 1rem; flex-grow: 1;">${job.description}</p>
                        
                        <div style="font-size: 0.875rem; margin-bottom: 0.5rem; color: #374151;">
                            <strong>Cron:</strong> <span style="font-family: monospace; background-color: #f1f1f1; padding: 2px 6px; border-radius: 4px;">${job.cronExpression}</span>
                        </div>
                         <div style="font-size: 0.875rem; margin-bottom: 0.5rem; color: #374151;">
                            <strong>Next Run:</strong> <span id="next-run-${job.id}" style="font-weight: 600; color: ${job.skipCount > 0 ? '#b45309' : '#065f46'};">${nextRunTime}</span>
                        </div>
                        <div style="font-size: 0.875rem; color: #4b5563;">
                            <strong>Script Snippet:</strong>
                            <div class="script-preview">${scriptSummary}</div>
                        </div>

                        <div style="margin-top: 1rem;">
                           <button class="btn btn-skip btn-small" onclick="handleSkipJob('${job.id}')">
                               Skip Next Run 
                           </button>
                        </div>
                        
                        <div class="card-footer flex-row-between">
                            <p>Created: ${formatTimestamp(job.createdAt)}</p>
                            <div class="card-actions">
                                <button class="edit" onclick='openEditModal(${JSON.stringify(job)})'>
                                    Edit
                                </button>
                                |
                                <button class="delete" onclick="openConfirmModal('${job.id}')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                jobsListEl.appendChild(jobCard);
            });
        }

        // --- Modal Controls ---

        window.openEditModal = (job = null) => {
            const isEditing = job !== null;
            document.getElementById('job-id').value = isEditing ? job.id : '';
            document.getElementById('title').value = isEditing ? job.title : '';
            document.getElementById('description').value = isEditing ? job.description : '';
            document.getElementById('cron-expression').value = isEditing ? job.cronExpression : '';
            
            // Set script content for editing (always in the textarea, even if uploaded)
            document.getElementById('script-content-input').value = isEditing ? job.scriptContent : '';
            document.getElementById('script-content-final').value = isEditing ? job.scriptContent : '';


            // Default to writing mode on open
            document.querySelector('input[name="script-source"][value="write"]').checked = true;
            document.querySelector('input[name="script-source"]').dispatchEvent(new Event('change'));
            
            // Clear file input status
            scriptFileInputEl.value = '';
            document.getElementById('file-status').textContent = '(File content will be read and saved with the job)';

            document.getElementById('modal-title').textContent = isEditing ? 'Edit Scheduled Job' : 'Add New Scheduled Job';
            document.getElementById('modal-submit-button').textContent = isEditing ? 'Update Job' : 'Save Job';

            editModalEl.classList.add('is-visible');
        };

        window.closeEditModal = () => {
            editModalEl.classList.remove('is-visible');
            jobFormEl.reset();
            document.getElementById('job-id').value = '';
        };

        let jobIdToDelete = null;

        window.openConfirmModal = (jobId) => {
            jobIdToDelete = jobId;
            document.getElementById('confirm-delete-button').onclick = () => handleJobDelete(jobIdToDelete);
            confirmModalEl.classList.add('is-visible');
        };

        window.closeConfirmModal = () => {
            confirmModalEl.classList.remove('is-visible');
            jobIdToDelete = null;
        };


        // --- Event Handlers (CRUD Logic) ---

        /** Handles clicking the Skip Next Run button. */
        async function handleSkipJob(jobId) {
            const jobIndex = jobs.findIndex(j => j.id === jobId);
            if (jobIndex === -1) return showStatus('Job not found.', true);

            // This is the MOCK implementation. Replace with the actual fetch call below:
            // await fetch(`/api/jobs/${jobId}/skip`, { method: 'POST', headers: {'Content-Type': 'application/json'} });

            // Mock: Increment the skipCount
            const newSkipCount = jobs[jobIndex].skipCount + 1;
            
            try {
                // MOCK API Call to update the skip count
                await updateJob(jobId, { skipCount: newSkipCount });
                
                showStatus(`Job ID ${jobId} successfully skipped! Next run advanced to the next schedule.`, false);
                
                // Re-render the list to show the new next run time
                loadJobs();
            } catch (error) {
                console.error("Error skipping job:", error);
                showStatus(`Failed to skip job. Error: ${error.message || 'Unknown error'}`, true);
            }
        }

        /** Initial loading of jobs. */
        async function loadJobs() {
            try {
                const response = await fetchJobs();
                if (response.success) {
                    renderJobs(response.data);
                }
            } catch (error) {
                console.error("Error loading jobs:", error);
                showStatus('Failed to load jobs. Please try again.', true);
            }
        }

        /** Handles saving (create or update) a job. */
        jobFormEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const jobId = document.getElementById('job-id').value;
            
            // Determine the final script content based on the selected mode
            let finalScriptContent = '';
            const scriptSource = document.querySelector('input[name="script-source"]:checked').value;
            
            if (scriptSource === 'write') {
                finalScriptContent = scriptContentInputEl.value;
            } else {
                finalScriptContent = scriptContentFinalEl.value;
            }

            const jobData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                cronExpression: document.getElementById('cron-expression').value,
                scriptContent: finalScriptContent, // Use the determined content
                skipCount: 0, // Ensure new/updated job resets skipCount
            };

            // Basic validation
            if (!jobData.title || !jobData.cronExpression || !jobData.scriptContent) {
                showStatus('Please fill out all required fields and ensure a script is provided (via writing or upload).', true);
                return;
            }

            closeEditModal();

            try {
                if (jobId) {
                    // UPDATE
                    await updateJob(jobId, jobData);
                    showStatus('Scheduled job successfully updated!', false);
                } else {
                    // CREATE
                    await createJob(jobData);
                    showStatus('New scheduled job successfully added!', false);
                }
                // Re-render the list after successful operation
                loadJobs();
            } catch (error) {
                console.error("Error saving job:", error);
                showStatus(`Failed to save job. Error: ${error.message || 'Unknown error'}`, true);
            }
        });

        /** Handles deleting a job. */
        async function handleJobDelete(jobId) {
            closeConfirmModal();
            try {
                await deleteJob(jobId);
                showStatus('Scheduled job successfully deleted!', false);
                // Re-render the list
                loadJobs();
            } catch (error) {
                console.error("Error deleting job:", error);
                showStatus('Failed to delete job. Please try again.', true);
            }
        }

        // --- Initialization ---

        // Load jobs when the page loads
        window.addEventListener('load', loadJobs);

        // Close modal when clicking outside (on the overlay)
        editModalEl.addEventListener('click', (e) => {
            if (e.target === editModalEl) {
                closeEditModal();
            }
        });
        confirmModalEl.addEventListener('click', (e) => {
            if (e.target === confirmModalEl) {
                closeConfirmModal();
            }
        });
    </script>
</body>
</html>
