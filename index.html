<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Switch - Scheduled Job Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load cronstrue library for human-readable CRON descriptions -->
    <script src="https://cdn.jsdelivr.net/npm/cronstrue@latest/dist/cronstrue.min.js"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            font-family: 'Inter', sans-serif;
            /* Modern, subtle background */
            background-color: #f7f9fc; 
            min-height: 100vh;
        }
        .card {
            /* Enhanced shadow for a lifted, modern look */
            box-shadow: 0 12px 24px -6px rgba(10, 20, 40, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 32px -8px rgba(10, 20, 40, 0.15), 0 6px 10px -3px rgba(0, 0, 0, 0.08);
        }
        .main-container {
            min-height: calc(100vh - 4rem); /* Header space */
        }
        /* Style for text inputs and textareas */
        .input-style {
            width: 100%;
            padding: 0.65rem 1rem; /* Slightly larger padding */
            border: 1px solid #e2e8f0; /* Lighter border */
            border-radius: 0.75rem; /* More rounded */
            transition: all 150ms ease-in-out;
            background-color: #ffffff; /* Explicit white background */
        }
        .input-style:focus {
            outline: none;
            border-color: #4f46e5; /* Deeper indigo */
            box-shadow: 0 0 0 3px #c7d2fe; /* Soft indigo ring */
        }
        /* Style for the submit button to include a subtle gradient */
        .primary-btn {
            background-image: linear-gradient(to right, #6366f1, #4f46e5);
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .primary-btn:hover {
            box-shadow: 0 8px 15px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        /* Modal specific styles for transition */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        
    </style>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app" class="flex flex-col items-center main-container">
        
        <!-- Header - Made it sticky and added a distinct shadow/color -->
        <header id="header-bar" class="w-full fixed top-0 bg-white shadow-lg z-30">
            <div class="max-w-7xl mx-auto flex justify-between items-center px-4 sm:px-8 py-3 border-b border-gray-100">
                <h1 class="text-2xl font-extrabold text-indigo-700 tracking-tight flex items-center">
                    <span class="text-3xl mr-2">âš¡</span> TheSwitch
                    <span class="hidden sm:inline text-xs ml-4 px-2 py-0.5 bg-indigo-50 text-indigo-600 rounded-full font-medium">Job Manager</span>
                </h1>
                <button id="logout-button" class="hidden px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-lg hover:bg-red-600 transition duration-150" onclick="handleLogout()">
                    Logout
                </button>
            </div>
        </header>

        <!-- Dynamic Content Area (Offset for sticky header) -->
        <main id="content-area" class="w-full max-w-7xl flex justify-center items-start pt-24 pb-8 px-4 sm:px-8"></main>

    </div>

    <!-- Execution History Modal (Hidden by default) -->
    <div id="history-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-overlay flex items-center justify-center" onclick="if (event.target === this) closeHistoryModal()">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl m-4 modal-content transform translate-y-0 opacity-100">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-indigo-50 rounded-t-2xl">
                <h3 id="history-modal-title" class="text-xl font-extrabold text-indigo-700">Execution History</h3>
                <button onclick="closeHistoryModal()" class="p-2 rounded-full text-indigo-500 hover:bg-indigo-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                    <path d="M18 6 6 18"/>
                    <path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div id="history-modal-body" class="p-6">
                <!-- Content will be injected here -->
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t border-gray-100 flex justify-end">
                <button onclick="closeHistoryModal()" class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-150">
                    Close
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- Global State and Constants ---
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('authToken');
        let jobList = []; // Cache for job data

        // --- Utility Functions ---

        function escapeHtml(str) { 
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); 
        }

        function renderIcon(name, classes = 'w-5 h-5') {
            const icon = lucide.icons[name];
            if (!icon) return '';
            // Ensure class includes a margin for icons used inline in text/buttons
            return icon.toSvg({ class: classes });
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('app');
            let bgColor = 'bg-blue-500';
            let icon = 'info';
            if (type === 'success') { bgColor = 'bg-green-500'; icon = 'check'; }
            if (type === 'error') { bgColor = 'bg-red-500'; icon = 'x-circle'; }

            const messageBox = document.createElement('div');
            // Improved toast message styling
            messageBox.className = `fixed top-20 right-4 p-4 pr-6 text-white rounded-xl shadow-2xl z-50 transition-all duration-300 ease-in-out transform translate-x-full opacity-0 ${bgColor} flex items-center space-x-2`;
            messageBox.innerHTML = `${renderIcon(icon, 'w-5 h-5')} <span class="font-semibold">${escapeHtml(message)}</span>`;
            
            container.appendChild(messageBox);
            
            // Show animation
            setTimeout(() => {
                messageBox.classList.remove('translate-x-full', 'opacity-0');
                messageBox.classList.add('translate-x-0', 'opacity-100');
            }, 10); // Small delay to ensure transition works

            // Hide animation
            setTimeout(() => {
                messageBox.classList.remove('translate-x-0', 'opacity-100');
                messageBox.classList.add('translate-x-full', 'opacity-0');
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }

        // --- Auth & Network ---

        async function authFetch(url, options = {}) {
            if (!authToken) {
                renderLogin();
                return { ok: false, status: 401, json: () => ({ error: "Not authenticated" }) };
            }

            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
            };
            
            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                    // Token expired or invalid
                    handleLogout();
                    showMessage("Your session expired. Please log in again.", 'error');
                }
                return response;
            } catch (error) {
                console.error("Network error during fetch:", error);
                // Return a mock response object for network failures
                return { ok: false, status: 500, json: () => ({ error: "Network connection failed" }) };
            }
        }

        function updateAuthState(isLoggedIn) {
            const logoutBtn = document.getElementById('logout-button');
            if (isLoggedIn) {
                logoutBtn.classList.remove('hidden');
            } else {
                logoutBtn.classList.add('hidden');
            }
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            authToken = null;
            updateAuthState(false);
            renderLogin();
        }
        
        // --- Rendering Logic: Login ---

        function renderLogin() {
            updateAuthState(false);
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="w-full max-w-sm p-10 bg-white rounded-2xl card space-y-8">
                    <h2 class="text-3xl font-extrabold text-center text-indigo-600">Welcome Back</h2>
                    <form id="login-form" onsubmit="event.preventDefault(); handleLogin(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                                <input type="text" id="username" name="username" value="admin" class="mt-1 input-style" required>
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="password" name="password" value="password" class="mt-1 input-style" required>
                            </div>
                        </div>
                        <button type="submit" class="primary-btn w-full mt-8 py-3 px-4 text-white font-bold rounded-xl shadow-lg transition duration-300 ease-in-out">
                            Sign In
                        </button>
                    </form>
                    <p class="text-xs text-center text-gray-400">Hint: Use 'admin' / 'password' for demo login.</p>
                </div>
            `;
        }

        async function handleLogin(event) {
            const form = event.target;
            const username = form.username.value;
            const password = form.password.value;

            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (response.ok) {
                    authToken = result.token;
                    localStorage.setItem('authToken', authToken);
                    showMessage("Login successful!", 'success');
                    renderDashboard();
                } else {
                    showMessage(result.error || "Login failed.", 'error');
                }
            } catch (error) {
                showMessage("A network error occurred during login.", 'error');
            }
        }

        // --- Rendering Logic: Dashboard ---

        function renderDashboard() {
            updateAuthState(true);
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="w-full max-w-7xl">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 p-4 bg-white rounded-2xl card border-b-4 border-indigo-600">
                        <h2 class="text-3xl font-extrabold text-gray-800 mb-4 sm:mb-0">Scheduled Jobs</h2>
                        <button onclick="renderJobForm()" class="primary-btn px-6 py-3 flex items-center text-white font-bold rounded-xl shadow-lg transition duration-300">
                            ${renderIcon('plus', 'w-5 h-5 mr-2')} New Job
                        </button>
                    </div>
                    <div id="job-list-container">
                        <div class="p-10 text-center bg-white rounded-2xl card text-gray-500">
                            ${renderIcon('loader-2', 'w-6 h-6 animate-spin mx-auto mb-2')}
                            Loading jobs...
                        </div>
                    </div>
                </div>
            `;
            fetchJobs();
        }

        async function fetchJobs() {
            const response = await authFetch(`${API_BASE}/api/jobs/`, { method: 'GET' });
            
            if (response && response.ok) {
                jobList = await response.json();
                renderJobList(jobList);
            } else if (response) {
                const error = await response.json();
                showMessage(error.error || "Failed to fetch jobs.", 'error');
                document.getElementById('job-list-container').innerHTML = `<div class="p-10 text-center bg-red-100 rounded-2xl card text-red-700 border border-red-300">Error loading jobs: ${escapeHtml(error.error || 'Check API connection.')}</div>`;
            }
        }

        function renderJobList(jobs) {
            const container = document.getElementById('job-list-container');

            if (jobs.length === 0) {
                container.innerHTML = `<div class="p-10 text-center bg-white rounded-2xl card text-gray-500 border-2 border-dashed border-gray-300">
                    ${renderIcon('calendar-check', 'w-8 h-8 mx-auto mb-3 text-indigo-400')}
                    <p class="font-semibold text-lg">No jobs currently scheduled.</p> 
                    <p class="text-sm">Click 'New Job' above to start automating tasks.</p>
                </div>`;
                return;
            }

            let html = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            `;

            jobs.forEach(job => {
                const createdAt = new Date(job.createdAt).toLocaleString();
                
                let nextRunTimeDisplay = '<span class="text-gray-400">N/A</span>';
                let cronWarning = '';
                let nextRunColor = 'text-green-600';

                if (job.nextRunAt > 0) {
                    try {
                        // Use { use24HourTime: true } for consistency or omit if not specified
                        const cronDescription = cronstrue.toString(job.cronExpression, { verbose: true });
                        const nextRunDate = new Date(job.nextRunAt).toLocaleString();
                        nextRunTimeDisplay = `<span title="${cronDescription}" class="font-bold">${nextRunDate}</span>`;
                    } catch (e) {
                        nextRunTimeDisplay = '<span class="text-red-500 font-bold">Invalid CRON</span>';
                        cronWarning = `<div class="text-xs text-red-500 flex items-center mt-2 p-2 bg-red-50 rounded-lg">${renderIcon('alert-triangle', 'w-4 h-4 mr-1')} Invalid CRON expression.</div>`;
                        nextRunColor = 'text-red-500';
                    }
                } else if (job.nextRunAt === 0) {
                    nextRunTimeDisplay = '<span class="text-red-500 font-bold">Invalid CRON</span>';
                    cronWarning = `<div class="text-xs text-red-500 flex items-center mt-2 p-2 bg-red-50 rounded-lg">${renderIcon('alert-triangle', 'w-4 h-4 mr-1')} Invalid CRON expression.</div>`;
                    nextRunColor = 'text-red-500';
                }

                html += `
                    <div id="job-${escapeHtml(job.id)}" class="card bg-white p-6 rounded-2xl border-t-8 border-indigo-500 flex flex-col transition duration-300 hover:border-indigo-600">
                        <div class="flex justify-between items-start mb-4">
                            <!-- Added flex-1 and min-w-0 to allow title to shrink and buttons to stay visible -->
                            <h3 class="text-2xl font-extrabold text-gray-900 leading-tight flex-1 min-w-0 mr-4">${escapeHtml(job.title)}</h3>
                            <!-- Added flex-shrink-0 to ensure buttons take priority space -->
                            <div class="flex space-x-2">
                                <button onclick="renderJobForm('${escapeHtml(job.id)}')" title="Edit Job" class="flex items-center p-1 rounded-lg hover:bg-blue-100 text-blue-500 hover:text-blue-700 transition text-sm font-medium">
                                    ${renderIcon('square-pen', 'w-4 h-4')}
                                    <span class="ml-1">Edit</span>
                                </button>
                                <button onclick="confirmDeleteJob('${escapeHtml(job.id)}', '${escapeHtml(job.title)}')" title="Delete Job" class="flex items-center p-1 rounded-lg hover:bg-red-100 text-red-500 hover:text-red-700 transition text-sm font-medium">
                                    ${renderIcon('trash-2', 'w-4 h-4')}
                                    <span class="ml-1">Delete</span>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-500 mb-4 text-sm">${escapeHtml(job.description)}</p>
                        
                        <div class="grid grid-cols-2 gap-y-3 gap-x-4 mb-4 text-sm border-t border-b py-3 border-gray-100">
                            
                            <div class="flex items-center ${nextRunColor} font-semibold">
                                ${renderIcon('play-circle', 'w-4 h-4 mr-2 ' + nextRunColor.replace('text-', 'text-'))}
                                Next Run: <span class="ml-2">${nextRunTimeDisplay}</span>
                            </div>

                            <div class="flex items-center text-gray-700">
                                ${renderIcon('clock', 'w-4 h-4 mr-2 text-indigo-500')}
                                <strong>Cron:</strong> <code class="ml-2 font-mono bg-indigo-50 text-indigo-800 px-2 py-0.5 rounded-md text-xs font-bold">${escapeHtml(job.cronExpression)}</code>
                            </div>
                            
                            <div class="flex items-center text-gray-500">
                                ${renderIcon('calendar', 'w-4 h-4 mr-2 text-gray-400')}
                                Created: <span class="ml-2">${createdAt}</span>
                            </div>
                            <div class="flex items-center text-red-500 font-bold">
                                ${renderIcon('x-circle', 'w-4 h-4 mr-2 text-red-400')} Skip Count: <span id="skip-count-${escapeHtml(job.id)}" class="ml-2 font-extrabold text-red-600">${job.skipCount}</span>
                            </div>
                        </div> 
                        ${cronWarning}

                        <details class="mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <summary class="font-bold cursor-pointer text-sm flex items-center text-gray-700 hover:text-indigo-600 transition">
                                ${renderIcon('code', 'w-5 h-5 mr-2 text-indigo-500')} Script Content (View)
                            </summary>
                            <pre class="mt-3 text-xs overflow-x-auto p-3 bg-gray-100 rounded-lg text-gray-800 border border-gray-200 max-h-40">${escapeHtml(job.scriptContent)}</pre>
                        </details>
                        
                        <!-- Action buttons (Manual Run & Skip) -->
                        <div class="mt-auto flex space-x-3 pt-4 border-t border-gray-100">
                            <button onclick="handleManualRun('${escapeHtml(job.id)}', '${escapeHtml(job.title)}')" class="flex-1 px-4 py-2 text-sm text-indigo-800 bg-indigo-100 font-semibold rounded-xl hover:bg-indigo-200 transition duration-150 flex items-center justify-center shadow-md">
                                ${renderIcon('zap', 'w-4 h-4 mr-2')} Run Now
                            </button>
                            <button onclick="handleSkipJob('${escapeHtml(job.id)}')" class="flex-1 px-4 py-2 text-sm text-yellow-800 bg-yellow-100 font-semibold rounded-xl hover:bg-yellow-200 transition duration-150 flex items-center justify-center shadow-md">
                                ${renderIcon('chevrons-right', 'w-4 h-4 mr-2')} Skip Next
                            </button>
                        </div>
                        
                        <!-- Execution History Section (Now a Modal Trigger) -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button onclick="showHistoryModal('${escapeHtml(job.id)}', '${escapeHtml(job.title)}')" class="w-full px-4 py-2 text-sm text-gray-700 bg-gray-100 font-semibold rounded-xl hover:bg-gray-200 transition duration-150 flex items-center justify-center shadow-md">
                                ${renderIcon('history', 'w-4 h-4 mr-2')} View Execution History (Last 10)
                            </button>
                        </div>

                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        function confirmDeleteJob(jobId, jobTitle) {
            // Using a custom modal-like message box
            if (window.confirm(`Are you sure you want to delete the job '${jobTitle}'? This action cannot be undone.`)) {
                handleDeleteJob(jobId, jobTitle);
            }
        }

        async function handleDeleteJob(jobId, jobTitle) {
            const response = await authFetch(`${API_BASE}/api/jobs/${jobId}`, { method: 'DELETE' });

            if (response && response.status === 204) {
                showMessage(`Job '${jobTitle}' deleted successfully.`, 'success');
                // Remove job from the list immediately
                const jobElement = document.getElementById(`job-${jobId}`);
                if (jobElement) jobElement.classList.add('animate-out', 'fade-out', 'slide-out-to-right-4'); // Tailwind animation classes are not available by default, but applying a class for removal.
                
                // Use a short delay before actually removing the element
                setTimeout(() => {
                    if (jobElement) jobElement.remove();
                    
                    // Check if the list is empty and re-render if necessary
                    const jobListContainer = document.getElementById('job-list-container');
                    if (jobListContainer) {
                        const grid = jobListContainer.querySelector('.grid');
                        if (!grid || grid.children.length === 0) {
                            fetchJobs();
                        }
                    }
                }, 300);

            } else if (response) {
                const error = await response.json();
                showMessage(error.error || `Failed to delete job '${jobTitle}'.`, 'error');
            }
        }

        async function handleSkipJob(jobId) {
            const skipElement = document.getElementById(`skip-count-${jobId}`);
            const originalCount = skipElement.textContent;
            skipElement.innerHTML = `${renderIcon('loader-2', 'w-4 h-4 animate-spin inline')}`; // Loading indicator

            const response = await authFetch(`${API_BASE}/api/jobs/${jobId}/skip`, { method: 'POST' });
            
            if (response && response.ok) {
                const result = await response.json();
                skipElement.textContent = result.skipCount;
                showMessage("Job skip count incremented.", 'success');
            } else {
                skipElement.textContent = originalCount;
                const error = response ? await response.json() : { error: 'Connection failed' };
                showMessage(error.error || "Failed to skip job.", 'error');
            }
        }

        // --- Job Form and Submission (Updated for Feature 3) ---

        function getJobById(jobId) {
            return jobList.find(job => job.id === jobId);
        }

        // NEW: Function to add key/value inputs for EnvVars (Feature 3)
        function addEnvVarInput(key = '', value = '', isNew = false) {
            const container = document.getElementById('env-vars-container');
            if (!container) return;

            const div = document.createElement('div');
            div.className = 'flex space-x-3 items-center';
            // Use crypto.randomUUID for unique key in the DOM, not for API payload
            const uniqueId = crypto.randomUUID(); 
            div.innerHTML = `
                <input type="text" id="env-key-${uniqueId}" name="env-key" placeholder="KEY (e.g., API_TOKEN)" value="${escapeHtml(key)}" class="input-style flex-1 bg-white" required>
                <span class="text-xl font-bold text-gray-400">=</span>
                <input type="text" id="env-value-${uniqueId}" name="env-value" placeholder="VALUE (e.g., xyz123)" value="${escapeHtml(value)}" class="input-style flex-1 bg-white" required>
                <button type="button" onclick="this.parentNode.remove()" title="Remove Variable" class="p-2 text-red-500 hover:text-red-700 transition rounded-full hover:bg-red-50">
                    ${renderIcon('x', 'w-4 h-4')}
                </button>
            `;
            container.appendChild(div);

            // Focus on the key input for new rows
            if (isNew) {
                document.getElementById(`env-key-${uniqueId}`).focus();
            }
        }


        async function renderJobForm(jobId = null) {
            const contentArea = document.getElementById('content-area');
            let jobData = {
                title: '',
                description: '',
                cronExpression: '* * * * * *', // Default to every second for easy testing
                scriptContent: '#!/bin/bash\necho "Hello from the new job!"',
                skipCount: 0,
                envVars: {},
            };
            let isEdit = jobId !== null;

            if (isEdit) {
                jobData = getJobById(jobId);
                if (!jobData) {
                    showMessage("Job not found for editing.", 'error');
                    renderDashboard();
                    return;
                }
            }

            contentArea.innerHTML = `
                <div class="w-full max-w-4xl p-8 bg-white rounded-2xl card space-y-8">
                    <h2 class="text-3xl font-extrabold text-gray-800">${isEdit ? 'Edit Job' : 'Create New Job'}</h2>
                    
                    <form id="job-form" onsubmit="event.preventDefault(); handleJobSubmit(event, '${jobId || ''}')" class="w-full">
                        
                        <div class="mb-8 p-4 border rounded-xl bg-gray-50">
                            <label class="block text-xl font-bold text-indigo-700 mb-3 border-b border-indigo-200 pb-2 flex items-center">
                                ${renderIcon('list-checks', 'w-6 h-6 mr-2')} Core Details
                            </label>
                            <div class="mb-4">
                                <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                                <input type="text" id="title" name="title" value="${escapeHtml(jobData.title)}" class="mt-1 input-style" required>
                            </div>
                            <div class="mb-4">
                                <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea id="description" name="description" rows="2" class="mt-1 input-style">${escapeHtml(jobData.description)}</textarea>
                            </div>
                            <div class="mb-4">
                                <label for="cronExpression" class="block text-sm font-medium text-gray-700">CRON Expression (6 fields: second, minute, hour, day of month, month, day of week)</label>
                                <input type="text" id="cronExpression" name="cronExpression" value="${escapeHtml(jobData.cronExpression)}" class="mt-1 input-style font-mono text-base" required>
                                <p id="cron-description" class="text-sm mt-2 text-indigo-600 italic font-semibold flex items-center">${renderIcon('calendar-search', 'w-4 h-4 mr-1')}</p>
                            </div>
                        </div>

                        <div class="mb-8 p-4 border rounded-xl bg-gray-50">
                            <label class="block text-xl font-bold text-indigo-700 mb-3 border-b border-indigo-200 pb-2 flex items-center">
                                ${renderIcon('terminal', 'w-6 h-6 mr-2')} Script Content
                            </label>
                            <p class="text-sm text-gray-500 mb-2">The script will be executed using <code class="bg-gray-200 px-1 rounded text-xs font-mono">/bin/bash -c "..."</code></p>
                            <textarea id="scriptContent" name="scriptContent" rows="10" class="mt-1 input-style font-mono text-sm resize-none" required>${escapeHtml(jobData.scriptContent)}</textarea>
                        </div>
                        
                        <!-- Environment Variables Section -->
                        <div class="mb-8 p-4 border rounded-xl bg-gray-50">
                            <label class="block text-xl font-bold text-indigo-700 mb-3 border-b border-indigo-200 pb-2 flex items-center">
                                ${renderIcon('lock', 'w-6 h-6 mr-2')} Environment Variables (Optional)
                            </label>
                            <p class="text-sm text-gray-500 mb-4">Define key-value pairs that will be available as shell environment variables. Use this for secure tokens/secrets.</p>
                            <div id="env-vars-container" class="space-y-4">
                                <!-- Key/Value inputs will be appended here by JS -->
                            </div>
                            <button type="button" onclick="addEnvVarInput('', '', true)" class="mt-4 px-4 py-2 text-sm flex items-center bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-150 shadow-md">
                                ${renderIcon('plus', 'w-4 h-4 mr-1')} Add Variable
                            </button>
                        </div>

                        ${isEdit ? `
                            <div class="mb-8 p-4 border rounded-xl bg-gray-50">
                                <label class="block text-xl font-bold text-indigo-700 mb-3 border-b border-indigo-200 pb-2 flex items-center">
                                    ${renderIcon('chevrons-right', 'w-6 h-6 mr-2')} Skip Count
                                </label>
                                <p class="text-sm text-gray-500 mb-2">The number of times the next scheduled execution will be skipped before running.</p>
                                <input type="number" id="skipCount" name="skipCount" value="${jobData.skipCount}" min="0" class="mt-1 input-style w-24" required>
                            </div>
                        ` : ''}

                        <div class="flex justify-between items-center pt-4 border-t mt-6">
                            <button type="button" onclick="renderDashboard()" class="px-5 py-2 text-gray-600 font-semibold rounded-xl hover:bg-gray-100 transition duration-150 flex items-center">
                                ${renderIcon('arrow-left', 'w-5 h-5 mr-2')} Back to List
                            </button>
                            <button type="submit" id="submit-button" class="primary-btn px-6 py-3 flex items-center text-white font-bold rounded-xl shadow-lg transition duration-300">
                                ${isEdit ? renderIcon('save', 'w-5 h-5 mr-2') + ' Save Changes' : renderIcon('send', 'w-5 h-5 mr-2') + ' Create Job'}
                            </button>
                        </div>
                    </form>
                </div>
            `;

            // Function to update the CRON description in real time
            const updateCronDescription = () => {
                const cronInput = document.getElementById('cronExpression').value;
                const descElement = document.getElementById('cron-description');
                
                // Clear previous state and add icon
                descElement.innerHTML = `${renderIcon('calendar-search', 'w-4 h-4 mr-1')}`;
                
                try {
                    const descriptionText = cronstrue.toString(cronInput);
                    descElement.innerHTML += descriptionText;
                    descElement.classList.remove('text-red-500');
                    descElement.classList.add('text-indigo-600');
                } catch (e) {
                    descElement.innerHTML += 'Error: Invalid CRON expression format. Must include 6 fields.';
                    descElement.classList.remove('text-indigo-600');
                    descElement.classList.add('text-red-500');
                }
            };

            // Set up CRON listener
            const cronInput = document.getElementById('cronExpression');
            cronInput.addEventListener('input', updateCronDescription);
            updateCronDescription(); // Initial update

            // Populate EnvVars section for edit (Feature 3)
            if (isEdit && jobData.envVars && Object.keys(jobData.envVars).length > 0) {
                Object.entries(jobData.envVars).forEach(([key, value]) => {
                    addEnvVarInput(key, value, false);
                });
            } else {
                // Add one empty row by default
                addEnvVarInput('', '', false); 
            }
        }


        async function handleJobSubmit(event, jobId) {
            const form = event.target;
            const title = form.title.value;
            const description = form.description.value;
            const cronExpression = form.cronExpression.value;
            const scriptContent = form.scriptContent.value;
            const skipCount = form.skipCount ? parseInt(form.skipCount.value) : 0;
            
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            const originalButtonText = submitButton.innerHTML;
            submitButton.innerHTML = `${renderIcon('loader-2', 'w-5 h-5 animate-spin mr-2')} Processing...`;

            // Extract Environment Variables (Feature 3)
            const envVars = {};
            // Select all key and value inputs by their name attribute
            const keyInputs = form.querySelectorAll('input[name="env-key"]');
            const valueInputs = form.querySelectorAll('input[name="env-value"]');
            
            keyInputs.forEach((keyInput, index) => {
                const key = keyInput.value.trim();
                const value = valueInputs[index].value.trim();
                if (key !== '' && value !== '') {
                    envVars[key] = value;
                }
            });


            const jobData = {
                title,
                description,
                cronExpression,
                scriptContent,
                skipCount,
                // Add EnvVars to jobData
                envVars: envVars, 
            };
            
            let response;
            let method;
            let url;

            if (jobId) {
                method = 'PUT';
                url = `${API_BASE}/api/jobs/${jobId}`;
            } else {
                method = 'POST';
                url = `${API_BASE}/api/jobs/`;
            }

            try {
                response = await authFetch(url, {
                    method: method,
                    body: JSON.stringify(jobData)
                });

                const result = await response.json();

                if (response.ok || response.status === 200) {
                    showMessage(`Job ${jobId ? 'updated' : 'created'} successfully!`, 'success');
                    renderDashboard();
                } else {
                    showMessage(result.error || `Failed to ${jobId ? 'update' : 'create'} job.`, 'error');
                }
            } catch (error) {
                showMessage("A network error occurred.", 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }

        // --- Manual Run Logic (Feature 2) ---

        async function handleManualRun(jobId, jobTitle) {
            // Using a custom modal-like message box
            if (!window.confirm(`Are you sure you want to manually run job '${jobTitle}' now?`)) return;

            const runButton = document.querySelector(`#job-${jobId} button[onclick*='handleManualRun']`);
            const originalContent = runButton.innerHTML;
            runButton.disabled = true;
            runButton.innerHTML = `${renderIcon('loader-2', 'w-4 h-4 animate-spin mr-2')} Running...`;

            try {
                const response = await authFetch(`${API_BASE}/api/jobs/${jobId}/run`, { method: 'POST' });
                const result = await response.json();

                if (response.status === 202) {
                    showMessage(`Job '${jobTitle}' triggered successfully!`, 'success');
                } else {
                    showMessage(result.error || `Failed to trigger manual run for job '${jobTitle}'.`, 'error');
                }
            } catch (error) {
                showMessage(`A network error occurred during manual run for job '${jobTitle}'.`, 'error');
            } finally {
                runButton.disabled = false;
                runButton.innerHTML = originalContent;
                
                // If the history modal is open, force a refresh
                const modal = document.getElementById('history-modal');
                if (!modal.classList.contains('hidden')) {
                    // Slight delay to allow backend goroutine to finish logging (optimistic approach)
                    setTimeout(() => loadJobHistory(jobId), 500); 
                }
            }
        }

        // --- History Logic (Modal Implementation) ---

        async function showHistoryModal(jobId, jobTitle) {
            const modal = document.getElementById('history-modal');
            const modalTitle = document.getElementById('history-modal-title');
            const modalBody = document.getElementById('history-modal-body');

            modalTitle.textContent = `Execution History: ${jobTitle}`;
            
            // Show loading spinner while fetching
            modalBody.innerHTML = `<p class="text-md text-gray-500 text-center py-6">${renderIcon('loader-2', 'w-6 h-6 animate-spin inline mr-2')} Loading execution records...</p>`;
            
            // Show modal
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden'); // Prevent background scrolling

            // Fetch and render history
            await loadJobHistory(jobId);
        }

        function closeHistoryModal() {
            const modal = document.getElementById('history-modal');
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            document.getElementById('history-modal-body').innerHTML = ''; // Clear content
        }

        async function loadJobHistory(jobId) {
            const contentDiv = document.getElementById('history-modal-body');
            
            const response = await authFetch(`${API_BASE}/api/jobs/${jobId}/history`, { method: 'GET' });
            
            if (response && response.ok) {
                const history = await response.json();
                renderHistoryListInModal(history);
            } else {
                const error = response ? await response.json() : { error: 'Connection failed' };
                contentDiv.innerHTML = `<div class="text-center p-6 text-red-500">Error: Failed to load history. ${escapeHtml(error.error || 'Unknown error')}</div>`;
            }
        }

        function renderHistoryListInModal(history) {
            const contentDiv = document.getElementById('history-modal-body');
            
            if (history.length === 0) {
                contentDiv.innerHTML = `<p class="text-md text-gray-500 text-center py-6">${renderIcon('calendar-check', 'w-6 h-6 mx-auto mb-2')} No execution records found yet.</p>`;
                return;
            }

            // Max height and scroll added to the content wrapper
            let html = `<div class="space-y-4 max-h-[70vh] overflow-y-auto p-1">`;
            history.forEach(exec => {
                const isSuccess = exec.status === 'Success';
                const statusColor = isSuccess ? 'text-green-700' : 'text-red-700';
                const bgColor = isSuccess ? 'bg-green-50' : 'bg-red-50';
                const iconName = isSuccess ? 'check-circle' : 'x-circle';
                const startTime = new Date(exec.startTime).toLocaleTimeString(); 
                const fullDateTime = new Date(exec.startTime).toLocaleString(); 
                const durationSeconds = (exec.duration / 1000).toFixed(2);
                const exitCodeDisplay = exec.exitCode >= 0 ? exec.exitCode : 'N/A'; 

                html += `
                    <details class="p-3 rounded-xl ${bgColor} border border-gray-200 shadow-sm">
                        <summary class="text-sm font-bold flex justify-between items-center cursor-pointer hover:opacity-80 transition ${statusColor}">
                            <div class="flex items-center">
                                ${renderIcon(iconName, 'w-4 h-4 mr-2')} 
                                <span class="font-extrabold">${escapeHtml(exec.status)}</span>
                                <span class="ml-4 text-gray-600 font-normal text-xs" title="${fullDateTime}">@ ${startTime}</span>
                            </div>
                            <div class="text-gray-500 font-normal text-right text-xs">
                                <span class="hidden sm:inline">Duration:</span> ${durationSeconds}s, Exit: ${exitCodeDisplay}
                            </div>
                        </summary>
                        <pre class="mt-2 text-xs overflow-x-auto p-2 bg-white rounded-md text-gray-800 max-h-40 whitespace-pre-wrap border border-gray-100">${escapeHtml(exec.output || 'No output recorded.')}</pre>
                    </details>
                `;
            });
            html += `</div>`;
            contentDiv.innerHTML = html;
        }


        // --- Initialization ---

        // Check auth status on load and render the correct view
        window.onload = function() {
            // Need to set the global API base for the bot.go to work in the canvas environment
            window.API_BASE = window.location.origin;

            if (authToken) {
                renderDashboard();
            } else {
                renderLogin();
            }
        };

    </script>
</body>
</html>
