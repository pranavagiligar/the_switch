<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduled Job Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .main-container {
            min-height: calc(100vh - 4rem); /* Header space */
        }
        /* FIX: Replaced @apply with native CSS for compatibility with CDN-loaded Tailwind */
        .input-style {
            width: 100%; /* w-full */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border: 1px solid #d1d5db; /* border border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 150ms ease-in-out; /* transition duration-150 */
        }
        .input-style:focus {
            outline: none;
            border-color: #6366f1; /* focus:border-indigo-500 */
            /* Simulates focus:ring-2 focus:ring-indigo-500 */
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #6366f1; 
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Application Container -->
    <div id="app" class="flex flex-col items-center p-4 sm:p-8 main-container">
        
        <!-- Header -->
        <header id="header-bar" class="w-full max-w-7xl flex justify-between items-center mb-6 py-3 border-b border-gray-200">
            <h1 class="text-2xl font-extrabold text-indigo-700 tracking-tight">
                <span class="text-3xl mr-1">âš¡</span> JobScheduler
            </h1>
            <button id="logout-button" class="hidden px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150" onclick="handleLogout()">
                Logout
            </button>
        </header>

        <!-- Dynamic Content Area -->
        <main id="content-area" class="w-full max-w-4xl flex justify-center items-start pt-10"></main>

    </div>

    <script>
        // --- Global State and Constants ---
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('authToken');

        // --- Utility Functions ---

        /**
         * Safely escapes HTML string content to prevent XSS.
         * @param {string} str The string to escape.
         * @returns {string} The escaped string.
         */
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        /**
         * Renders Lucide icons inline.
         * @param {string} name The icon name (e.g., 'plus', 'trash-2').
         * @param {string} classes Tailwind classes for size and color.
         * @returns {string} The SVG string.
         */
        function renderIcon(name, classes = 'w-5 h-5') {
            const icon = lucide.icons[name];
            if (!icon) return '';
            return icon.toSvg({ class: classes });
        }

        /**
         * Displays a temporary, non-disruptive message box instead of alert().
         * @param {string} message The message to display.
         * @param {string} type 'success', 'error', or 'info'.
         */
        function showMessage(message, type = 'info') {
            const container = document.getElementById('app');
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';

            const messageBox = document.createElement('div');
            messageBox.className = `fixed top-4 right-4 p-4 text-white rounded-lg shadow-xl z-50 transition-all duration-300 ${bgColor}`;
            messageBox.innerHTML = escapeHtml(message);
            
            container.appendChild(messageBox);
            
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }

        /**
         * Wrapper for fetch to handle authentication and errors.
         * @param {string} url 
         * @param {object} options 
         * @returns {Promise<Response>}
         */
        async function authFetch(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };

            // Only add Authorization header if a token exists and we are hitting an API path
            if (authToken && url.startsWith('/api/')) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            options.headers = headers;
            
            try {
                const response = await fetch(url, options);

                if (response.status === 401 && url.startsWith('/api/')) {
                    // Token expired or invalid, force re-login
                    showMessage("Session expired. Please log in again.", 'error');
                    handleLogout(false); // Don't show success message
                    return; // Stop further processing
                }
                
                return response;

            } catch (error) {
                console.error("Network or Fetch Error:", error);
                showMessage("A network error occurred. Check server connection.", 'error');
                throw error;
            }
        }

        // --- Authentication Logic ---

        function updateAuthState(token) {
            authToken = token;
            if (token) {
                localStorage.setItem('authToken', token);
                document.getElementById('logout-button').classList.remove('hidden');
                renderDashboard();
            } else {
                localStorage.removeItem('authToken');
                document.getElementById('logout-button').classList.add('hidden');
                renderLogin();
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = event.target.username.value;
            const password = event.target.password.value;
            const loginButton = event.target.querySelector('button[type="submit"]');

            loginButton.disabled = true;
            loginButton.innerHTML = `${renderIcon('loader-2', 'w-5 h-5 animate-spin mr-2')} Authenticating...`;

            try {
                const response = await authFetch('/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(result.message || "Login successful!", 'success');
                    updateAuthState(result.token);
                } else {
                    showMessage(result.error || "Login failed.", 'error');
                }
            } catch (error) {
                showMessage("Could not connect to server.", 'error');
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = 'Login';
            }
        }

        function handleLogout(showSuccess = true) {
            updateAuthState(null);
            if (showSuccess) {
                showMessage("Logged out successfully.", 'info');
            }
        }

        // --- Rendering Logic: Login View ---

        function renderLogin() {
            const contentArea = document.getElementById('content-area');
            contentArea.className = "w-full max-w-md flex justify-center items-start pt-10"; // Center content
            contentArea.innerHTML = `
                <div class="card bg-white p-8 rounded-xl w-full">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Admin Login</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username (Default: admin)</label>
                            <input type="text" id="username" name="username" class="input-style" value="admin" required autocomplete="username">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password (Default: password)</label>
                            <input type="password" id="password" name="password" class="input-style" value="password" required autocomplete="current-password">
                        </div>
                        <button type="submit" class="w-full flex items-center justify-center bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition duration-150">
                            Login
                        </button>
                    </form>
                    <p class="mt-4 text-xs text-gray-500 text-center">
                        Note: The server uses 'admin'/'password' by default.
                    </p>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        // --- Rendering Logic: Dashboard View ---
        
        async function renderDashboard() {
            const contentArea = document.getElementById('content-area');
            contentArea.className = "w-full max-w-7xl flex flex-col items-center pt-0"; // Full width for dashboard
            contentArea.innerHTML = `
                <div class="w-full flex justify-end mb-6">
                    <button onclick="renderJobForm()" class="px-5 py-2 flex items-center bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                        ${renderIcon('plus', 'w-5 h-5 mr-2')} New Job
                    </button>
                </div>
                <div id="job-list-container" class="w-full">
                    <p class="text-center text-gray-500">${renderIcon('loader-2', 'w-6 h-6 animate-spin inline mr-2')} Loading scheduled jobs...</p>
                </div>
            `;
            fetchJobs();
        }

        async function fetchJobs() {
            const container = document.getElementById('job-list-container');
            container.innerHTML = `<p class="text-center text-gray-500">${renderIcon('loader-2', 'w-6 h-6 animate-spin inline mr-2')} Loading scheduled jobs...</p>`;

            const response = await authFetch('/api/jobs', { method: 'GET' });

            if (response && response.ok) {
                const jobs = await response.json();
                renderJobList(jobs);
            } else if (response) {
                const error = await response.json();
                container.innerHTML = `<p class="text-center text-red-500">Error fetching jobs: ${escapeHtml(error.error || 'Unknown error')}</p>`;
            } else {
                container.innerHTML = `<p class="text-center text-red-500">Failed to connect to the API server.</p>`;
            }
        }

        function renderJobList(jobs) {
            const container = document.getElementById('job-list-container');

            if (jobs.length === 0) {
                container.innerHTML = `<div class="p-10 text-center bg-white rounded-xl card text-gray-500">No jobs currently scheduled. Click 'New Job' to add one.</div>`;
                return;
            }

            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            `;

            jobs.forEach(job => {
                const createdAt = new Date(job.createdAt).toLocaleString();
                
                // CRON Warning Logic
                const cronParts = job.cronExpression.trim().split(/\s+/).filter(p => p.length > 0);
                const isFiveField = cronParts.length === 5;
                const cronWarning = isFiveField ? `
                    <p class="mt-2 text-xs text-red-600 flex items-center p-2 bg-red-50 rounded-lg">
                        ${renderIcon('alert-triangle', 'w-4 h-4 mr-1 flex-shrink-0')} 
                        **Warning:** This job uses the old 5-field CRON format. The server requires 6 fields. Please edit the job and update the CRON expression (e.g., from * * * * * to 0 * * * * *).
                    </p>
                ` : '';


                html += `
                    <div id="job-${escapeHtml(job.id)}" class="card bg-white p-6 rounded-xl border-l-4 border-indigo-500 flex flex-col">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-semibold text-gray-800">${escapeHtml(job.title)}</h3>
                            <div class="flex space-x-2">
                                <!-- UPDATED: Added visible text labels for accessibility and fallback -->
                                <button onclick="renderJobForm('${escapeHtml(job.id)}')" title="Edit Job" class="flex items-center p-1 rounded-lg hover:bg-blue-100 text-blue-500 hover:text-blue-700 transition text-sm font-medium">
                                    ${renderIcon('square-pen', 'w-4 h-4')}
                                    <span class="ml-1">Edit</span>
                                </button>
                                <button onclick="confirmDeleteJob('${escapeHtml(job.id)}', '${escapeHtml(job.title)}')" title="Delete Job" class="flex items-center p-1 rounded-lg hover:bg-red-100 text-red-500 hover:text-red-700 transition text-sm font-medium">
                                    ${renderIcon('trash-2', 'w-4 h-4')}
                                    <span class="ml-1">Delete</span>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-600 mb-3">${escapeHtml(job.description)}</p>
                        
                        <div class="space-y-1 mb-4 text-sm">
                            <div class="flex items-center text-gray-700">
                                ${renderIcon('clock', 'w-4 h-4 mr-2 text-indigo-500')}
                                <strong>Cron:</strong> <code class="ml-2 font-mono bg-gray-100 px-2 py-0.5 rounded">${escapeHtml(job.cronExpression)}</code>
                            </div>
                            <div class="flex items-center text-gray-500">
                                ${renderIcon('calendar', 'w-4 h-4 mr-2 text-gray-500')}
                                <span title="Created at Unix Epoch in milliseconds">Created:</span> <span class="ml-2">${createdAt}</span>
                            </div>
                            <div class="flex items-center text-gray-500">
                                ${renderIcon('x-circle', 'w-4 h-4 mr-2 text-red-500')}
                                Skip Count: <span id="skip-count-${escapeHtml(job.id)}" class="ml-2 font-bold">${job.skipCount}</span>
                            </div>
                        </div>

                        ${cronWarning}

                        <details class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <summary class="font-medium cursor-pointer text-sm flex items-center">
                                ${renderIcon('code', 'w-4 h-4 mr-2')} Script Content (Click to View)
                            </summary>
                            <pre class="mt-2 text-xs overflow-x-auto p-2 bg-gray-100 rounded-md text-gray-800">${escapeHtml(job.scriptContent)}</pre>
                        </details>

                        <button onclick="handleSkipJob('${escapeHtml(job.id)}')" class="mt-auto px-4 py-2 text-sm text-yellow-800 bg-yellow-200 font-semibold rounded-lg hover:bg-yellow-300 transition duration-150 flex items-center justify-center">
                            ${renderIcon('chevrons-right', 'w-4 h-4 mr-2')} Skip Next Execution
                        </button>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        async function handleSkipJob(jobId) {
            const skipButton = document.querySelector(`#job-${jobId} button[onclick*='handleSkipJob']`);
            const skipCountElement = document.getElementById(`skip-count-${jobId}`);

            if (skipButton) {
                skipButton.disabled = true;
                skipButton.innerHTML = `${renderIcon('loader-2', 'w-4 h-4 animate-spin mr-2')} Skipping...`;
            }

            const response = await authFetch(`/api/jobs/${jobId}/skip`, { method: 'POST' });

            if (response && response.ok) {
                const result = await response.json();
                skipCountElement.textContent = result.skipCount;
                showMessage(`Job ${jobId} skip count incremented to ${result.skipCount}.`, 'success');
            } else if (response) {
                const error = await response.json();
                showMessage(error.error || `Failed to skip job ${jobId}.`, 'error');
            }

            if (skipButton) {
                skipButton.disabled = false;
                skipButton.innerHTML = `${renderIcon('chevrons-right', 'w-4 h-4 mr-2')} Skip Next Execution`;
            }
        }
        
        // --- Form Logic (Create/Edit) ---

        let editingJob = null; // Stores job data if editing

        async function renderJobForm(jobId = null) {
            const contentArea = document.getElementById('content-area');
            contentArea.className = "w-full max-w-2xl flex justify-center items-start pt-0";
            
            let title = "Create New Scheduled Job";
            let submitText = "Create Job";
            editingJob = null;
            
            if (jobId) {
                title = "Edit Scheduled Job";
                submitText = "Save Changes";
                // Fetch job data for editing
                const response = await authFetch('/api/jobs', { method: 'GET' });
                if (response && response.ok) {
                    const jobs = await response.json();
                    editingJob = jobs.find(j => j.id === jobId);
                    if (!editingJob) {
                        showMessage("Job not found for editing.", 'error');
                        renderDashboard();
                        return;
                    }
                } else {
                    showMessage("Failed to load job data for editing.", 'error');
                    renderDashboard();
                    return;
                }
            }

            contentArea.innerHTML = `
                <div class="card bg-white p-8 rounded-xl w-full">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        ${jobId ? renderIcon('square-pen', 'w-6 h-6 mr-2 text-indigo-500') : renderIcon('plus-circle', 'w-6 h-6 mr-2 text-indigo-500')} 
                        ${escapeHtml(title)}
                    </h2>
                    <form id="job-form">
                        <input type="hidden" name="id" value="${editingJob ? escapeHtml(editingJob.id) : ''}">
                        
                        <div class="mb-4">
                            <label for="job-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" id="job-title" name="title" class="input-style" value="${editingJob ? escapeHtml(editingJob.title) : ''}" required>
                        </div>

                        <div class="mb-4">
                            <label for="job-description" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                            <textarea id="job-description" name="description" rows="2" class="input-style resize-none">${editingJob ? escapeHtml(editingJob.description) : ''}</textarea>
                        </div>
                        
                        <div class="mb-4">
                            <!-- UPDATED: Added Seconds (S) field and updated pattern -->
                            <label for="job-cron" class="block text-sm font-medium text-gray-700 mb-1">Cron Expression <span class="text-xs text-gray-500">(S M H D M W - e.g., 0 * * * * *)</span></label>
                            <input type="text" id="job-cron" name="cronExpression" class="input-style font-mono" value="${editingJob ? escapeHtml(editingJob.cronExpression) : '0 2 * * * *'}" required 
                                pattern="^(\\*|\\d+|\\*\\/\\d+)(\\s+(\\*|\\d+|\\*\\/\\d+)){5}$" 
                                title="Must be a valid 6-part cron expression (Seconds, Minute, Hour, Day, Month, Weekday). Example: 0 * * * * *">
                            <p class="text-xs text-red-500 mt-1">**IMPORTANT:** This server requires 6 fields. Prepend 0 for Seconds (e.g., use <code class='font-mono'>0 * * * * *</code> instead of <code class='font-mono'>* * * * *</code>).</p>
                        </div>

                        <div class="mb-6">
                            <label for="job-script" class="block text-sm font-medium text-gray-700 mb-1">Script Content (Bash, Python, etc.)</label>
                            <textarea id="job-script" name="scriptContent" rows="6" class="input-style font-mono text-sm">${editingJob ? escapeHtml(editingJob.scriptContent) : '#!/bin/bash\necho "Hello from my scheduled job!"'}</textarea>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button type="button" onclick="renderDashboard()" class="w-1/3 flex items-center justify-center bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg hover:bg-gray-400 transition duration-150">
                                ${renderIcon('x', 'w-5 h-5 mr-2')} Cancel
                            </button>
                            <button type="submit" class="w-2/3 flex items-center justify-center bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition duration-150">
                                ${renderIcon('save', 'w-5 h-5 mr-2')} ${submitText}
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('job-form').addEventListener('submit', handleSaveJob);
        }

        async function handleSaveJob(event) {
            event.preventDefault();
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');

            const jobData = {
                id: form.id.value || undefined,
                title: form.title.value,
                description: form.description.value,
                cronExpression: form.cronExpression.value,
                scriptContent: form.scriptContent.value,
            };

            submitButton.disabled = true;
            submitButton.innerHTML = `${renderIcon('loader-2', 'w-5 h-5 animate-spin mr-2')} Saving...`;

            try {
                const response = await authFetch('/api/jobs', {
                    method: 'POST',
                    body: JSON.stringify(jobData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(jobData.id ? `Job '${jobData.title}' updated successfully!` : `New job '${jobData.title}' created successfully!`, 'success');
                    renderDashboard();
                } else {
                    showMessage(result.error || "Failed to save job.", 'error');
                }
            } catch (error) {
                showMessage("Could not connect to server.", 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `${renderIcon('save', 'w-5 h-5 mr-2')} ${jobData.id ? 'Save Changes' : 'Create Job'}`;
            }
        }

        // --- Deletion Confirmation ---

        function confirmDeleteJob(jobId, jobTitle) {
            const contentArea = document.getElementById('content-area');
            const originalContent = contentArea.innerHTML;
            
            // Simple overlay modal simulation
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
                    <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center">
                        ${renderIcon('alert-triangle', 'w-6 h-6 mr-2')} Confirm Deletion
                    </h3>
                    <p class="text-gray-700 mb-6">Are you sure you want to permanently delete the job: <code class="font-semibold text-gray-900">${escapeHtml(jobTitle)}</code>?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-delete" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                        <button id="confirm-delete" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition">
                            ${renderIcon('trash-2', 'w-5 h-5 mr-2')} Delete
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            document.getElementById('cancel-delete').onclick = () => modal.remove();
            document.getElementById('confirm-delete').onclick = () => {
                modal.remove();
                handleDeleteJob(jobId, jobTitle);
            };
        }

        async function handleDeleteJob(jobId, jobTitle) {
            const response = await authFetch(`/api/jobs/${jobId}`, { method: 'DELETE' });

            if (response && response.status === 204) {
                showMessage(`Job '${jobTitle}' deleted successfully.`, 'success');
                // Remove job from the list immediately
                const jobElement = document.getElementById(`job-${jobId}`);
                if (jobElement) jobElement.remove();
                
                // If the list is now empty, re-render dashboard to show empty state
                const jobListContainer = document.getElementById('job-list-container');
                if (jobListContainer) {
                    const grid = jobListContainer.querySelector('.grid');
                    if (!grid || grid.children.length === 0) {
                        // Re-fetch jobs to ensure the empty state is displayed correctly
                        fetchJobs();
                    }
                }
            } else if (response) {
                const error = await response.json();
                showMessage(error.error || `Failed to delete job '${jobTitle}'.`, 'error');
            }
        }

        // --- Initialization ---

        // Check auth status on load and render the correct view
        window.onload = function() {
            if (authToken) {
                renderDashboard();
            } else {
                renderLogin();
            }
        };

    </script>
</body>
</html>
